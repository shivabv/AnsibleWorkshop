---
- name: Health Check Playbook for Windows
  hosts: all
  gather_facts: yes
  
  tasks:
    - name: Check CPU usage
      win_shell: "Get-WmiObject -Class Win32_Processor | Select-Object -ExpandProperty LoadPercentage"
      register: cpu_result
  
    - name: Check memory usage
      win_shell: "Get-Counter -Counter '\\Memory\\% Committed Bytes In Use' | Select-Object -ExpandProperty CounterSamples | Select-Object -ExpandProperty CookedValue"
      register: memory_result
  
    - name: Check uptime
      win_shell: "Get-CimInstance -ClassName Win32_OperatingSystem | Select-Object -ExpandProperty LastBootUpTime"
      register: uptime_result
  
    - name: Check ping
      win_ping:
      register: ping_result
  
    - name: Save results to CSV
      win_shell: |
        $results = @{
          'Server Name' = $env:COMPUTERNAME
          'CPU Usage' = "{{ cpu_result.stdout }}"
          'Memory Usage' = "{{ memory_result.stdout }}"
          'Uptime' = "{{ uptime_result.stdout }}"
          'Ping' = "{{ ping_result.ping }}"
        }
        $results | Export-Csv -Path "C:\health-check-results.csv" -Append -NoTypeInformation
          
